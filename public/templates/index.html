<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ˆë“±í•™ìƒìš© ì˜ì–´ Short Story ë° Teacher's Talk Script ìë™ ìƒì„± ì—ì´ì „íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            position: relative;
        }

        .user-info {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .user-info span {
            margin-right: 15px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .form-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .example-btn {
            background: #28a745;
            margin-left: 10px;
        }

        .result-section {
            padding: 30px;
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .result-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .story-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 18px;
            line-height: 1.8;
        }

        .script-section {
            margin-top: 15px;
        }

        .script-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .script-item strong {
            color: #667eea;
            display: block;
            margin-bottom: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .metadata {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .copy-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .copy-btn:hover {
            background: #138496;
        }

        .tts-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            margin-left: 10px;
        }

        .tts-btn:hover {
            background: #218838;
        }

        .tts-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .tts-controls {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .tts-controls label {
            font-size: 14px;
            margin-right: 10px;
        }

        .tts-controls select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            margin-right: 15px;
        }

        .tts-controls input[type="range"] {
            margin-right: 10px;
        }

        .tts-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .interactive-script {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .question-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }

        .question-item.active {
            border-color: #4caf50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .question-text {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .interaction-controls {
            margin: 10px 0;
        }

        .record-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        .record-btn:hover {
            background: #d32f2f;
        }

        .record-btn.recording {
            background: #ff5722;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .play-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .play-btn:hover {
            background: #1976d2;
        }

        .transcription {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-style: italic;
            color: #666;
        }

        .evaluation {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .feedback {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .score {
            font-weight: bold;
            color: #4caf50;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hattie-feedback {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .hattie-section {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }

        .hattie-question {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffd700;
        }

        .hattie-answer {
            font-size: 16px;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .strengths-list, .improvements-list, .actions-list {
            list-style: none;
            padding: 0;
        }

        .strengths-list li::before {
            content: "âœ… ";
        }

        .improvements-list li::before {
            content: "ğŸ¯ ";
        }

        .actions-list li::before {
            content: "ğŸ“ ";
        }

        .hattie-principles {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }

        .effect-size {
            background: #ffd700;
            color: #333;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 5px 0;
        }

        .rewrite-section {
            background: #f8f9fa;
            border: 2px solid #6c757d;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .rewrite-activity {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .blank-input {
            border: 2px dashed #007bff;
            background: #e3f2fd;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: #007bff;
            min-width: 100px;
            text-align: center;
        }

        .blank-input:focus {
            outline: none;
            border-color: #0056b3;
            background: #bbdefb;
        }

        .story-text {
            line-height: 2;
            font-size: 16px;
            margin: 15px 0;
        }

        .rewrite-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
        }

        .rewrite-textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .rubric-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .rubric-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .rubric-item h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }

        .rubric-score {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .activity-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .activity-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .activity-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .activity-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .activity-btn.secondary {
            background: #6c757d;
        }

        .activity-btn.secondary:hover {
            background: #545b62;
        }

        .activity-btn.success {
            background: #28a745;
        }

        .activity-btn.success:hover {
            background: #1e7e34;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info">
                <span id="userName">ì‚¬ìš©ì</span>
                <span id="userSchool"></span>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <h1>ğŸ“ ì˜ì–´ ìˆ˜ì—… ìë£Œ ìë™ ìƒì„± ì—ì´ì „íŠ¸</h1>
            <p>ì´ˆë“±í•™ìƒìš© Short Storyì™€ Teacher's Talk Scriptë¥¼ ì‰½ê²Œ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
            <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">
                ğŸ”Š ìƒì„±ëœ ì´ì•¼ê¸°ëŠ” ì†Œë¦¬ë‚´ì–´ ì½ê¸° ê¸°ëŠ¥ì„ ì§€ì›í•©ë‹ˆë‹¤
            </p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <form id="unitForm">
                    <div class="form-group">
                        <label for="communicative_functions">ëª©í‘œ ì˜ì‚¬ì†Œí†µ ê¸°ëŠ¥ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                        <input type="text" id="communicative_functions" 
                               placeholder="ì˜ˆ: ëŠ¥ë ¥ ë¬»ê³  ë‹µí•˜ê¸°, ê°ì • ë¬»ê³  ë‹µí•˜ê¸°" required>
                    </div>

                    <div class="form-group">
                        <label for="grammar_forms">ëª©í‘œ ë¬¸ë²• í˜•íƒœ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                        <input type="text" id="grammar_forms" 
                               placeholder="ì˜ˆ: I can..., Can you...?, Yes, I can. / No, I can't." required>
                    </div>

                    <div class="form-group">
                        <label for="vocabulary">ëª©í‘œ ì–´íœ˜ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                        <input type="text" id="vocabulary" 
                               placeholder="ì˜ˆ: bird, fish, frog, fly, swim, jump" required>
                    </div>

                    <div>
                        <button type="submit" class="btn" id="generateBtn">ìë£Œ ìƒì„±í•˜ê¸°</button>
                        <button type="button" class="btn example-btn" id="exampleBtn">ì˜ˆì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </div>
                </form>
            </div>

            <div class="result-section" id="resultSection">
                <div id="loadingDiv" class="loading" style="display: none;">
                    <p>ğŸ“š ìˆ˜ì—… ìë£Œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>

                <div id="errorDiv" class="error" style="display: none;"></div>

                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <script>
        // ì¸ì¦ ê´€ë ¨ ë³€ìˆ˜
        let currentUser = null;

        // ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function getToken() {
            return localStorage.getItem('access_token');
        }

        function setToken(token) {
            localStorage.setItem('access_token', token);
        }

        function removeToken() {
            localStorage.removeItem('access_token');
        }

        function getAuthHeaders() {
            const token = getToken();
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        async function checkAuth() {
            const token = getToken();
            if (!token) {
                window.location.href = '/';
                return false;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    currentUser = await response.json();
                    updateUserInfo();
                    return true;
                } else {
                    removeToken();
                    window.location.href = '/';
                    return false;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                removeToken();
                window.location.href = '/';
                return false;
            }
        }

        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name;
                if (currentUser.school) {
                    document.getElementById('userSchool').textContent = `(${currentUser.school})`;
                }
            }
        }

        async function logout() {
            try {
                await fetch('/auth/logout', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                removeToken();
                window.location.href = '/';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ í™•ì¸
        window.addEventListener('load', async () => {
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return;
            }
        });

        document.getElementById('unitForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const generateBtn = document.getElementById('generateBtn');
            const loadingDiv = document.getElementById('loadingDiv');
            const errorDiv = document.getElementById('errorDiv');
            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');
            
            // UI ìƒíƒœ ì´ˆê¸°í™”
            generateBtn.disabled = true;
            generateBtn.textContent = 'ìƒì„± ì¤‘...';
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            resultSection.classList.add('show');
            
            try {
                // í¼ ë°ì´í„° ìˆ˜ì§‘
                const formData = {
                    target_communicative_functions: document.getElementById('communicative_functions').value.split(',').map(s => s.trim()),
                    target_grammar_forms: document.getElementById('grammar_forms').value.split(',').map(s => s.trim()),
                    target_vocabulary: document.getElementById('vocabulary').value.split(',').map(s => s.trim())
                };
                
                // API í˜¸ì¶œ
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayResults(result.data);
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                showError('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'ìë£Œ ìƒì„±í•˜ê¸°';
                loadingDiv.style.display = 'none';
            }
        });
        
        document.getElementById('exampleBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/example', {
                    headers: getAuthHeaders()
                });
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('communicative_functions').value = result.data.target_communicative_functions.join(', ');
                    document.getElementById('grammar_forms').value = result.data.target_grammar_forms.join(', ');
                    document.getElementById('vocabulary').value = result.data.target_vocabulary.join(', ');
                }
            } catch (error) {
                showError('ì˜ˆì‹œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });
        
        function displayResults(data) {
            const resultContent = document.getElementById('resultContent');
            
            // TTS ìƒíƒœ ì´ˆê¸°í™”
            isPlaying = false;
            speechSynthesis.cancel();
            
            // í˜„ì¬ ìŠ¤í† ë¦¬ ì €ì¥
            currentStory = data.short_story.content;
            
            resultContent.innerHTML = `
                <div class="result-card">
                    <h3>ğŸ“– Short Story: ${data.short_story.title}</h3>
                    <div class="story-content">
                        ${data.short_story.content}
                    </div>
                    <div class="metadata">
                        ë¬¸ì¥ ìˆ˜: ${data.short_story.sentence_count}ê°œ | ë‹¨ì–´ ìˆ˜: ${data.short_story.word_count}ê°œ
                    </div>
                    <button class="copy-btn" onclick="copyToClipboard('story')">ì´ì•¼ê¸° ë³µì‚¬</button>
                    <button class="tts-btn" id="ttsBtn" onclick="toggleTTS()">ğŸ”Š ì†Œë¦¬ë‚´ì–´ ì½ê¸°</button>
                    
                    <div class="tts-controls" id="ttsControls" style="display: none;">
                        <label for="voiceSelect">ìŒì„±:</label>
                        <select id="voiceSelect">
                            <option value="">ê¸°ë³¸ ìŒì„±</option>
                        </select>
                        
                        <label for="rateRange">ì†ë„:</label>
                        <input type="range" id="rateRange" min="0.5" max="2" step="0.1" value="1">
                        <span id="rateValue">1.0</span>
                        
                        <label for="pitchRange">ìŒì¡°:</label>
                        <input type="range" id="pitchRange" min="0.5" max="2" step="0.1" value="1">
                        <span id="pitchValue">1.0</span>
                        
                        <button class="tts-btn" onclick="stopTTS()">â¹ï¸ ì •ì§€</button>
                        <div class="tts-status" id="ttsStatus"></div>
                    </div>
                    
                    <div class="rewrite-section">
                        <h4>âœï¸ Rewrite í™œë™</h4>
                        <p>ìŠ¤í† ë¦¬ë¥¼ ë‹¤ì‹œ ì¨ë³´ë©° ì˜ì–´ ì‹¤ë ¥ì„ í–¥ìƒì‹œì¼œë³´ì„¸ìš”!</p>
                        
                        <div class="activity-buttons">
                            <button class="activity-btn" onclick="startVocabularyFill()">1ë‹¨ê³„: ì–´íœ˜ ë¹ˆì¹¸ ì±„ìš°ê¸°</button>
                            <button class="activity-btn secondary" onclick="startFullRewrite()">2ë‹¨ê³„: ì „ì²´ ìŠ¤í† ë¦¬ ë‹¤ì‹œ ì“°ê¸°</button>
                        </div>
                        
                        <div id="rewriteActivityContainer"></div>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>ğŸ‘©â€ğŸ« Teacher's Talk Script</h3>
                    
                    <div class="interactive-script">
                        <h4>ğŸ¤ ìƒí˜¸ì‘ìš© ìˆ˜ì—… ëª¨ë“œ</h4>
                        <p>ì§ˆë¬¸ì„ ë“£ê³  ë‹µë³€ì„ ë…¹ìŒí•´ë³´ì„¸ìš”. AIê°€ í‰ê°€í•˜ê³  í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
                        <button class="btn" onclick="startInteractiveMode()">ìƒí˜¸ì‘ìš© ìˆ˜ì—… ì‹œì‘</button>
                    </div>
                    
                    <div class="script-section">
                        <div class="script-item">
                            <strong>1. Opening (ë„ì…)</strong>
                            ${data.teacher_script.opening.map(item => `<div style="margin: 8px 0;">${item}</div>`).join('')}
                        </div>
                        
                        <div class="script-item">
                            <strong>2. During-Reading (ì½ê¸° ì¤‘)</strong>
                            ${data.teacher_script.during_reading.map(item => `<div style="margin: 8px 0;">${item}</div>`).join('')}
                        </div>
                        
                        <div class="script-item">
                            <strong>3. After-Reading (ì½ê¸° í›„)</strong>
                            ${data.teacher_script.after_reading.map(item => `<div style="margin: 8px 0;">${item}</div>`).join('')}
                        </div>
                        
                        <div class="script-item">
                            <strong>4. Key Expression Practice (í•µì‹¬ í‘œí˜„ ì—°ìŠµ)</strong>
                            ${data.teacher_script.key_expression_practice.map(item => `<div style="margin: 8px 0;">${item}</div>`).join('')}
                        </div>
                        
                        <div class="script-item">
                            <strong>5. Retelling Guidance (ë¦¬í…”ë§ ê°€ì´ë“œ) - 9ê°œ ì˜ì—­ ê¸°ë°˜</strong>
                            <div style="background: #e8f4fd; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 14px; color: #0066cc;">
                                <strong>í‰ê°€ ì˜ì—­:</strong> Characters & Setting, Initiating Event, Internal Reaction, Attempts/Actions, Result/Resolution, Ending/Closure, Causal Connection, Temporal Connection, Global Organization
                            </div>
                            ${data.teacher_script.retelling_guidance.map(item => `<div style="margin: 8px 0;">${item}</div>`).join('')}
                        </div>
                        
                        <div class="script-item">
                            <strong>6. Evaluation Criteria (í‰ê°€ ê¸°ì¤€) - 0-3ì  ì²™ë„ (ì´ 27ì  ë§Œì )</strong>
                            <div style="background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 14px; color: #856404;">
                                <strong>ì ìˆ˜ ê¸°ì¤€:</strong> 21-27ì : ìš°ìˆ˜, 15-20ì : ì–‘í˜¸, 9-14ì : ë³´í†µ, 0-8ì : ê°œì„  í•„ìš”
                            </div>
                            ${data.teacher_script.evaluation_criteria.map(item => `<div style="margin: 8px 0;">${item}</div>`).join('')}
                        </div>
                        
                        <div class="script-item">
                            <strong>7. Wrap-Up (ë§ˆë¬´ë¦¬)</strong>
                            ${data.teacher_script.wrap_up.map(item => `<div style="margin: 8px 0;">${item}</div>`).join('')}
                        </div>
                    </div>
                    
                    <button class="copy-btn" onclick="copyToClipboard('script')">ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬</button>
                </div>
                
                <div class="result-card">
                    <h3>ğŸ“Š í’ˆì§ˆ ê²€ì¦ ê²°ê³¼</h3>
                    <div class="metadata">
                        <p><strong>ì „ì²´ ì ìˆ˜:</strong> ${data.quality_check.overall_score}/100ì </p>
                        <p><strong>ì´ì•¼ê¸° í’ˆì§ˆ:</strong> ${data.quality_check.story_quality.score}/100ì </p>
                        <p><strong>ìŠ¤í¬ë¦½íŠ¸ í’ˆì§ˆ:</strong> ${data.quality_check.script_quality.score}/100ì </p>
                        ${data.quality_check.story_quality.issues.length > 0 ? 
                            `<p><strong>ì´ì•¼ê¸° ê°œì„ ì‚¬í•­:</strong> ${data.quality_check.story_quality.issues.join(', ')}</p>` : ''}
                        ${data.quality_check.script_quality.issues.length > 0 ? 
                            `<p><strong>ìŠ¤í¬ë¦½íŠ¸ ê°œì„ ì‚¬í•­:</strong> ${data.quality_check.script_quality.issues.join(', ')}</p>` : ''}
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>ğŸ“Š ìƒì„± ì •ë³´</h3>
                    <div class="metadata">
                        <p><strong>ìƒì„± ì‹œê°„:</strong> ${data.metadata.generation_timestamp}</p>
                        <p><strong>CEFR ë ˆë²¨:</strong> ${data.metadata.cefr_level}</p>
                        <p><strong>ëŒ€ìƒ í•™ë…„:</strong> ${data.metadata.target_grade}</p>
                    </div>
                </div>
            `;
            
            // TTS ìŒì„± ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
            setTimeout(() => {
                loadVoices();
            }, 100);
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function copyToClipboard(type) {
            const resultContent = document.getElementById('resultContent');
            let textToCopy = '';
            
            if (type === 'story') {
                const storyCard = resultContent.querySelector('.result-card');
                textToCopy = storyCard.textContent;
            } else if (type === 'script') {
                const scriptCard = resultContent.querySelectorAll('.result-card')[1];
                textToCopy = scriptCard.textContent;
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // TTS ê´€ë ¨ ë³€ìˆ˜
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let isPlaying = false;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŒì„± ëª©ë¡ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            loadVoices();
            // ìŒì„± ëª©ë¡ì´ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë¡œë“œë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            speechSynthesis.addEventListener('voiceschanged', loadVoices);
        });

        function loadVoices() {
            const voiceSelect = document.getElementById('voiceSelect');
            if (!voiceSelect) return;
            
            const voices = speechSynthesis.getVoices();
            voiceSelect.innerHTML = '<option value="">ê¸°ë³¸ ìŒì„±</option>';
            
            voices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
        }

        function toggleTTS() {
            const ttsControls = document.getElementById('ttsControls');
            const ttsBtn = document.getElementById('ttsBtn');
            
            if (ttsControls.style.display === 'none') {
                ttsControls.style.display = 'block';
                ttsBtn.textContent = 'ğŸ”Š ì†Œë¦¬ë‚´ì–´ ì½ê¸°';
            } else {
                if (isPlaying) {
                    stopTTS();
                } else {
                    startTTS();
                }
            }
        }

        function startTTS() {
            const resultContent = document.getElementById('resultContent');
            const storyCard = resultContent.querySelector('.result-card');
            const storyText = storyCard.querySelector('.story-content').textContent;
            
            if (!storyText) {
                alert('ì½ì„ ì´ì•¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì´ì „ ì¬ìƒ ì¤‘ì§€
            speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(storyText);
            currentUtterance = utterance;

            // ìŒì„± ì„¤ì •
            const voiceSelect = document.getElementById('voiceSelect');
            const rateRange = document.getElementById('rateRange');
            const pitchRange = document.getElementById('pitchRange');
            const ttsStatus = document.getElementById('ttsStatus');
            const ttsBtn = document.getElementById('ttsBtn');

            if (voiceSelect.value) {
                const voices = speechSynthesis.getVoices();
                utterance.voice = voices[voiceSelect.value];
            }

            utterance.rate = parseFloat(rateRange.value);
            utterance.pitch = parseFloat(pitchRange.value);
            utterance.lang = 'en-US'; // ì˜ì–´ë¡œ ì„¤ì •

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            utterance.onstart = function() {
                isPlaying = true;
                ttsBtn.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
                ttsStatus.textContent = 'ì½ëŠ” ì¤‘...';
            };

            utterance.onend = function() {
                isPlaying = false;
                ttsBtn.textContent = 'ğŸ”Š ì†Œë¦¬ë‚´ì–´ ì½ê¸°';
                ttsStatus.textContent = 'ì™„ë£Œ';
            };

            utterance.onerror = function(event) {
                isPlaying = false;
                ttsBtn.textContent = 'ğŸ”Š ì†Œë¦¬ë‚´ì–´ ì½ê¸°';
                ttsStatus.textContent = 'ì˜¤ë¥˜: ' + event.error;
                alert('ìŒì„± ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + event.error);
            };

            utterance.onpause = function() {
                isPlaying = false;
                ttsBtn.textContent = 'â–¶ï¸ ì¬ìƒ';
                ttsStatus.textContent = 'ì¼ì‹œì •ì§€ë¨';
            };

            utterance.onresume = function() {
                isPlaying = true;
                ttsBtn.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
                ttsStatus.textContent = 'ì½ëŠ” ì¤‘...';
            };

            // ì¬ìƒ ì‹œì‘
            speechSynthesis.speak(utterance);
        }

        function stopTTS() {
            speechSynthesis.cancel();
            isPlaying = false;
            const ttsBtn = document.getElementById('ttsBtn');
            const ttsStatus = document.getElementById('ttsStatus');
            
            if (ttsBtn) {
                ttsBtn.textContent = 'ğŸ”Š ì†Œë¦¬ë‚´ì–´ ì½ê¸°';
            }
            if (ttsStatus) {
                ttsStatus.textContent = 'ì •ì§€ë¨';
            }
        }

        // ìŠ¬ë¼ì´ë” ê°’ ì—…ë°ì´íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            const rateRange = document.getElementById('rateRange');
            const pitchRange = document.getElementById('pitchRange');
            const rateValue = document.getElementById('rateValue');
            const pitchValue = document.getElementById('pitchValue');

            if (rateRange && rateValue) {
                rateRange.addEventListener('input', function() {
                    rateValue.textContent = this.value;
                });
            }

            if (pitchRange && pitchValue) {
                pitchRange.addEventListener('input', function() {
                    pitchValue.textContent = this.value;
                });
            }
        });

        // ìƒí˜¸ì‘ìš© ëª¨ë“œ ê´€ë ¨ ë³€ìˆ˜
        let currentQuestionIndex = 0;
        let questions = [];
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let allEvaluations = []; // ëª¨ë“  í‰ê°€ ê²°ê³¼ ì €ì¥

        function startInteractiveMode() {
            // ì§ˆë¬¸ë“¤ì„ ìˆ˜ì§‘
            questions = [];
            allEvaluations = []; // í‰ê°€ ê²°ê³¼ ì´ˆê¸°í™”
            const scriptItems = document.querySelectorAll('.script-item');
            
            scriptItems.forEach((item, index) => {
                const questionDivs = item.querySelectorAll('div[style*="margin: 8px 0"]');
                questionDivs.forEach(div => {
                    const text = div.textContent.trim();
                    if (text && !text.includes('(êµì‚¬ìš© ë³´ì¡° ë°œí™”')) {
                        questions.push({
                            text: text,
                            section: item.querySelector('strong').textContent,
                            index: questions.length
                        });
                    }
                });
            });

            if (questions.length === 0) {
                alert('ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ìƒí˜¸ì‘ìš© ëª¨ë“œ UI ìƒì„±
            createInteractiveUI();
            showQuestion(0);
        }

        function createInteractiveUI() {
            const interactiveScript = document.querySelector('.interactive-script');
            interactiveScript.innerHTML = `
                <h4>ğŸ¤ ìƒí˜¸ì‘ìš© ìˆ˜ì—… ëª¨ë“œ</h4>
                <div id="questionContainer"></div>
                <div id="interactionControls" class="interaction-controls" style="display: none;">
                    <button class="play-btn" onclick="playQuestion()">ğŸ”Š ì§ˆë¬¸ ë“£ê¸°</button>
                    <button class="record-btn" id="recordBtn" onclick="toggleRecording()">ğŸ¤ ë‹µë³€ ë…¹ìŒ</button>
                    <button class="btn" onclick="nextQuestion()" id="nextBtn" disabled>ë‹¤ìŒ ì§ˆë¬¸</button>
                    <button class="btn" onclick="resetInteractiveMode()">ì²˜ìŒë¶€í„°</button>
                </div>
                <div id="progressInfo" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
            `;
        }

        function showQuestion(index) {
            if (index >= questions.length) {
                showFinalResults();
                return;
            }

            currentQuestionIndex = index;
            const question = questions[index];
            
            const questionContainer = document.getElementById('questionContainer');
            questionContainer.innerHTML = `
                <div class="question-item active">
                    <div class="question-text">${question.section}</div>
                    <div style="margin: 10px 0; font-size: 16px;">${question.text}</div>
                    <div id="transcription${index}" class="transcription" style="display: none;"></div>
                    <div id="evaluation${index}" class="evaluation" style="display: none;"></div>
                    <div id="feedback${index}" class="feedback" style="display: none;"></div>
                </div>
            `;

            document.getElementById('interactionControls').style.display = 'block';
            document.getElementById('progressInfo').textContent = `ì§ˆë¬¸ ${index + 1} / ${questions.length}`;
            
            // ì§ˆë¬¸ ìë™ ì¬ìƒ
            setTimeout(() => playQuestion(), 500);
        }

        function playQuestion() {
            const question = questions[currentQuestionIndex];
            const utterance = new SpeechSynthesisUtterance(question.text);
            utterance.lang = 'en-US';
            utterance.rate = 0.8;
            speechSynthesis.speak(utterance);
        }

        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        transcribeAudio(audioBlob);
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    
                    const recordBtn = document.getElementById('recordBtn');
                    recordBtn.textContent = 'â¹ï¸ ë…¹ìŒ ì¤‘ì§€';
                    recordBtn.classList.add('recording');
                })
                .catch(err => {
                    console.error('ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨:', err);
                    alert('ë§ˆì´í¬ ì ‘ê·¼ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                });
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                isRecording = false;
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.textContent = 'ğŸ¤ ë‹µë³€ ë…¹ìŒ';
                recordBtn.classList.remove('recording');
            }
        }

        async function transcribeAudio(audioBlob) {
            const transcriptionDiv = document.getElementById(`transcription${currentQuestionIndex}`);
            transcriptionDiv.innerHTML = '<div class="loading-spinner"></div> ì „ì‚¬ ì¤‘...';
            transcriptionDiv.style.display = 'block';

            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.wav');

                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    transcriptionDiv.innerHTML = `<strong>ì „ì‚¬ ê²°ê³¼:</strong> ${result.transcription}`;
                    evaluateAnswer(result.transcription);
                } else {
                    transcriptionDiv.innerHTML = `<strong>ì „ì‚¬ ì‹¤íŒ¨:</strong> ${result.error}`;
                }
            } catch (error) {
                console.error('ì „ì‚¬ ì˜¤ë¥˜:', error);
                transcriptionDiv.innerHTML = '<strong>ì „ì‚¬ ì˜¤ë¥˜:</strong> ì„œë²„ì™€ì˜ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            }
        }

        async function evaluateAnswer(transcription) {
            const evaluationDiv = document.getElementById(`evaluation${currentQuestionIndex}`);
            const feedbackDiv = document.getElementById(`feedback${currentQuestionIndex}`);
            
            evaluationDiv.innerHTML = '<div class="loading-spinner"></div> í‰ê°€ ì¤‘...';
            evaluationDiv.style.display = 'block';

            try {
                const question = questions[currentQuestionIndex];
                const response = await fetch('/api/evaluate', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        question: question.text,
                        answer: transcription,
                        section: question.section
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    evaluationDiv.innerHTML = `
                        <strong>í‰ê°€ ê²°ê³¼:</strong><br>
                        <div class="score">ì ìˆ˜: ${result.score}/10</div>
                        <div>ì •í™•ì„±: ${result.accuracy}</div>
                        <div>ìœ ì°½ì„±: ${result.fluency}</div>
                        <div>ë¬¸ë²•: ${result.grammar}</div>
                    `;
                    
                    feedbackDiv.innerHTML = `
                        <strong>í”¼ë“œë°±:</strong><br>
                        ${result.feedback}
                    `;
                    feedbackDiv.style.display = 'block';
                    
                    // í‰ê°€ ê²°ê³¼ ì €ì¥
                    allEvaluations.push({
                        question: question.text,
                        answer: transcription,
                        score: result.score,
                        accuracy: result.accuracy,
                        fluency: result.fluency,
                        grammar: result.grammar,
                        feedback: result.feedback
                    });
                } else {
                    evaluationDiv.innerHTML = `<strong>í‰ê°€ ì‹¤íŒ¨:</strong> ${result.error}`;
                }
            } catch (error) {
                console.error('í‰ê°€ ì˜¤ë¥˜:', error);
                evaluationDiv.innerHTML = '<strong>í‰ê°€ ì˜¤ë¥˜:</strong> ì„œë²„ì™€ì˜ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            }

            // ë‹¤ìŒ ì§ˆë¬¸ ë²„íŠ¼ í™œì„±í™”
            document.getElementById('nextBtn').disabled = false;
        }

        function nextQuestion() {
            showQuestion(currentQuestionIndex + 1);
        }

        function resetInteractiveMode() {
            currentQuestionIndex = 0;
            createInteractiveUI();
            showQuestion(0);
        }

        function showFinalResults() {
            const interactiveScript = document.querySelector('.interactive-script');
            interactiveScript.innerHTML = `
                <h4>ğŸ‰ ìƒí˜¸ì‘ìš© ìˆ˜ì—… ì™„ë£Œ!</h4>
                <p>ëª¨ë“  ì§ˆë¬¸ì— ë‹µë³€í•˜ì…¨ìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!</p>
                <button class="btn" onclick="generateHattieFeedback()">ğŸ“Š Hattie ì¢…í•© í”¼ë“œë°± ë³´ê¸°</button>
                <button class="btn" onclick="resetInteractiveMode()">ë‹¤ì‹œ ì‹œì‘</button>
            `;
        }

        // Rewrite í™œë™ ê´€ë ¨ ë³€ìˆ˜
        let currentStory = '';
        let currentActivity = null;

        function startVocabularyFill() {
            if (!currentStory) {
                alert('ë¨¼ì € ìŠ¤í† ë¦¬ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            const container = document.getElementById('rewriteActivityContainer');
            container.innerHTML = '<div class="loading-spinner"></div> ì–´íœ˜ ë¹ˆì¹¸ ì±„ìš°ê¸° í™œë™ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

            fetch('/api/create_rewrite_activity', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    story_content: currentStory,
                    activity_type: 'vocabulary_fill'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentActivity = data.activity;
                    displayVocabularyFillActivity(data.activity);
                } else {
                    container.innerHTML = `<div class="error">í™œë™ ìƒì„± ì‹¤íŒ¨: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                container.innerHTML = '<div class="error">í™œë™ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            });
        }

        function startFullRewrite() {
            if (!currentStory) {
                alert('ë¨¼ì € ìŠ¤í† ë¦¬ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            const container = document.getElementById('rewriteActivityContainer');
            container.innerHTML = '<div class="loading-spinner"></div> ì „ì²´ ë‹¤ì‹œ ì“°ê¸° í™œë™ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

            fetch('/api/create_rewrite_activity', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    story_content: currentStory,
                    activity_type: 'full_rewrite'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentActivity = data.activity;
                    displayFullRewriteActivity(data.activity);
                } else {
                    container.innerHTML = `<div class="error">í™œë™ ìƒì„± ì‹¤íŒ¨: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                container.innerHTML = '<div class="error">í™œë™ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            });
        }

        function displayVocabularyFillActivity(activity) {
            const container = document.getElementById('rewriteActivityContainer');
            
            // ë¹ˆì¹¸ì´ ìˆëŠ” ìŠ¤í† ë¦¬ í…ìŠ¤íŠ¸ ìƒì„±
            let storyWithBlanks = activity.modified_story;
            const blanks = activity.blanks;
            
            // ë¹ˆì¹¸ì„ ì…ë ¥ í•„ë“œë¡œ êµì²´
            blanks.forEach(blank => {
                const inputId = blank.id;
                const placeholder = blank.type === 'collocation' ? 'êµ¬ë¬¸ ì…ë ¥ (ì˜ˆ: in the sky)' : 'ë‹¨ì–´ ì…ë ¥';
                storyWithBlanks = storyWithBlanks.replace(
                    `__${inputId}__`,
                    `<input type="text" class="blank-input" id="${inputId}" placeholder="${placeholder}" data-type="${blank.type}">`
                );
            });

            container.innerHTML = `
                <div class="rewrite-activity">
                    <h4>1ë‹¨ê³„: ì–´íœ˜ ë¹ˆì¹¸ ì±„ìš°ê¸°</h4>
                    <p>ë¹ˆì¹¸ì— ì ì ˆí•œ ë‹¨ì–´ë‚˜ êµ¬ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë‹¨ì¼ ë‹¨ì–´ 30-40%, êµ¬ë¬¸ 60-70%)</p>
                    
                    <div class="story-text">
                        ${storyWithBlanks}
                    </div>
                    
                    <div class="activity-buttons">
                        <button class="activity-btn success" onclick="submitVocabularyFill()">ì œì¶œí•˜ê¸°</button>
                        <button class="activity-btn secondary" onclick="resetRewriteActivity()">ë‹¤ì‹œ ì‹œì‘</button>
                    </div>
                </div>
            `;
        }

        function displayFullRewriteActivity(activity) {
            const container = document.getElementById('rewriteActivityContainer');
            
            container.innerHTML = `
                <div class="rewrite-activity">
                    <h4>2ë‹¨ê³„: ì „ì²´ ìŠ¤í† ë¦¬ ë‹¤ì‹œ ì“°ê¸°</h4>
                    <p>ì›ë³¸ ìŠ¤í† ë¦¬ë¥¼ ë“£ê³  ìì‹ ë§Œì˜ ìŠ¤í† ë¦¬ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”.</p>
                    
                    <div class="story-text" style="text-align: center; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <strong>ì›ë³¸ ìŠ¤í† ë¦¬ ë“£ê¸°:</strong><br><br>
                        <button class="activity-btn" onclick="playOriginalStory()" id="playStoryBtn">ğŸ”Š ìŠ¤í† ë¦¬ ë“£ê¸°</button>
                        <button class="activity-btn secondary" onclick="stopOriginalStory()" id="stopStoryBtn" style="display: none;">â¹ï¸ ì •ì§€</button>
                        <div id="storyStatus" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label for="rewriteTextarea"><strong>ë‹¹ì‹ ì˜ ìŠ¤í† ë¦¬:</strong></label>
                        <textarea id="rewriteTextarea" class="rewrite-textarea" placeholder="ì›ë³¸ ìŠ¤í† ë¦¬ë¥¼ ë“£ê³  ì—¬ê¸°ì— ìŠ¤í† ë¦¬ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                    </div>
                    
                    <div class="activity-buttons">
                        <button class="activity-btn success" onclick="submitFullRewrite()">ì œì¶œí•˜ê¸°</button>
                        <button class="activity-btn secondary" onclick="resetRewriteActivity()">ë‹¤ì‹œ ì‹œì‘</button>
                    </div>
                </div>
            `;
        }

        function submitVocabularyFill() {
            const blanks = currentActivity.blanks;
            const studentAnswers = {};
            
            // í•™ìƒ ë‹µì•ˆ ìˆ˜ì§‘
            blanks.forEach(blank => {
                const input = document.getElementById(blank.id);
                if (input) {
                    studentAnswers[blank.id] = input.value.trim();
                }
            });

            // í‰ê°€ ìš”ì²­
            const container = document.getElementById('rewriteActivityContainer');
            container.innerHTML = '<div class="loading-spinner"></div> í‰ê°€ ì¤‘ì…ë‹ˆë‹¤...';

            fetch('/api/evaluate_rewrite_activity', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    activity_type: 'vocabulary_fill',
                    original_story: currentActivity.original_story,
                    student_answers: studentAnswers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayRewriteEvaluation(data.evaluation);
                } else {
                    container.innerHTML = `<div class="error">í‰ê°€ ì‹¤íŒ¨: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                container.innerHTML = '<div class="error">í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            });
        }

        function submitFullRewrite() {
            const studentStory = document.getElementById('rewriteTextarea').value.trim();
            
            if (!studentStory) {
                alert('ìŠ¤í† ë¦¬ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            // í‰ê°€ ìš”ì²­
            const container = document.getElementById('rewriteActivityContainer');
            container.innerHTML = '<div class="loading-spinner"></div> í‰ê°€ ì¤‘ì…ë‹ˆë‹¤...';

            fetch('/api/evaluate_rewrite_activity', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    activity_type: 'full_rewrite',
                    original_story: currentActivity.original_story,
                    student_content: studentStory
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayRewriteEvaluation(data.evaluation);
                } else {
                    container.innerHTML = `<div class="error">í‰ê°€ ì‹¤íŒ¨: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                container.innerHTML = '<div class="error">í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            });
        }

        function displayRewriteEvaluation(evaluation) {
            const container = document.getElementById('rewriteActivityContainer');
            
            const rubricScores = evaluation.score;
            const totalScore = evaluation.total_score;
            const feedback = evaluation.feedback;
            
            container.innerHTML = `
                <div class="rewrite-activity">
                    <h4>ğŸ“Š í‰ê°€ ê²°ê³¼</h4>
                    
                    <div class="rubric-scores">
                        <div class="rubric-item">
                            <h4>ë°°ê²½ ì„¤ì •</h4>
                            <div class="rubric-score">${rubricScores.setting?.toFixed(1) || '0.0'}/4.0</div>
                        </div>
                        <div class="rubric-item">
                            <h4>ë“±ì¥ì¸ë¬¼</h4>
                            <div class="rubric-score">${rubricScores.characters?.toFixed(1) || '0.0'}/4.0</div>
                        </div>
                        <div class="rubric-item">
                            <h4>ë¬¸ì œ ìƒí™©</h4>
                            <div class="rubric-score">${rubricScores.problem?.toFixed(1) || '0.0'}/4.0</div>
                        </div>
                        <div class="rubric-item">
                            <h4>ì‚¬ê±´ ì „ê°œ</h4>
                            <div class="rubric-score">${rubricScores.events?.toFixed(1) || '0.0'}/4.0</div>
                        </div>
                        <div class="rubric-item">
                            <h4>í•´ê²° ê³¼ì •</h4>
                            <div class="rubric-score">${rubricScores.resolution?.toFixed(1) || '0.0'}/4.0</div>
                        </div>
                        <div class="rubric-item">
                            <h4>ì£¼ì œ</h4>
                            <div class="rubric-score">${rubricScores.theme?.toFixed(1) || '0.0'}/4.0</div>
                        </div>
                        <div class="rubric-item">
                            <h4>ì–´íœ˜ ì‚¬ìš©</h4>
                            <div class="rubric-score">${rubricScores.vocabulary?.toFixed(1) || '0.0'}/4.0</div>
                        </div>
                        <div class="rubric-item">
                            <h4>ë¬¸ë²•</h4>
                            <div class="rubric-score">${rubricScores.grammar?.toFixed(1) || '0.0'}/4.0</div>
                        </div>
                        <div class="rubric-item">
                            <h4>ì¼ê´€ì„±</h4>
                            <div class="rubric-score">${rubricScores.coherence?.toFixed(1) || '0.0'}/4.0</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <h3>ì´ì : ${totalScore.toFixed(1)}/4.0</h3>
                    </div>
                    
                    <div class="hattie-feedback">
                        <h4>ğŸ“ Hattie ê¸°ë°˜ í”¼ë“œë°±</h4>
                        <div class="hattie-section">
                            <div class="hattie-question">ğŸ“ˆ ì „ì²´ í•™ìŠµ í‰ê°€</div>
                            <div class="hattie-answer">${feedback.overall_assessment}</div>
                        </div>
                        
                        <div class="hattie-section">
                            <div class="hattie-question">ğŸ¯ Hattieì˜ 3ê°€ì§€ í•µì‹¬ ì§ˆë¬¸</div>
                            <div style="margin: 10px 0;">
                                <strong>1. Where am I going? (ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€?)</strong><br>
                                ${feedback.hattie_analysis?.where_am_i_going || 'ë¶„ì„ ì¤‘...'}
                            </div>
                            <div style="margin: 10px 0;">
                                <strong>2. How am I going? (ì–´ë–»ê²Œ í•˜ê³  ìˆëŠ”ê°€?)</strong><br>
                                ${feedback.hattie_analysis?.how_am_i_going || 'ë¶„ì„ ì¤‘...'}
                            </div>
                            <div style="margin: 10px 0;">
                                <strong>3. Where to next? (ë‹¤ìŒì— ë¬´ì—‡ì„ í•´ì•¼ í•˜ëŠ”ê°€?)</strong><br>
                                ${feedback.hattie_analysis?.where_to_next || 'ë¶„ì„ ì¤‘...'}
                            </div>
                        </div>
                        
                        <div class="hattie-section">
                            <div class="hattie-question">âœ… ê°•ì </div>
                            <ul class="strengths-list">
                                ${feedback.strengths?.map(strength => `<li>${strength}</li>`).join('') || '<li>ë¶„ì„ ì¤‘...</li>'}
                            </ul>
                        </div>
                        
                        <div class="hattie-section">
                            <div class="hattie-question">ğŸ¯ ê°œì„  ì˜ì—­</div>
                            <ul class="improvements-list">
                                ${feedback.areas_for_improvement?.map(area => `<li>${area}</li>`).join('') || '<li>ë¶„ì„ ì¤‘...</li>'}
                            </ul>
                        </div>
                        
                        <div class="hattie-section">
                            <div class="hattie-question">ğŸ“ êµ¬ì²´ì  í–‰ë™ ê³„íš</div>
                            <ul class="actions-list">
                                ${feedback.specific_actions?.map(action => `<li>${action}</li>`).join('') || '<li>ë¶„ì„ ì¤‘...</li>'}
                            </ul>
                        </div>
                        
                        <div class="hattie-section">
                            <div class="hattie-question">ğŸ’ª ê²©ë ¤ ë©”ì‹œì§€</div>
                            <div class="hattie-answer">${feedback.encouragement || 'ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!'}</div>
                        </div>
                    </div>
                    
                    <div class="activity-buttons">
                        <button class="activity-btn" onclick="resetRewriteActivity()">ìƒˆë¡œìš´ í™œë™ ì‹œì‘</button>
                    </div>
                </div>
            `;
        }

        function resetRewriteActivity() {
            const container = document.getElementById('rewriteActivityContainer');
            container.innerHTML = '';
            currentActivity = null;
        }

        function playOriginalStory() {
            if (!currentActivity || !currentActivity.original_story) {
                alert('ì›ë³¸ ìŠ¤í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const playBtn = document.getElementById('playStoryBtn');
            const stopBtn = document.getElementById('stopStoryBtn');
            const statusDiv = document.getElementById('storyStatus');

            // ê¸°ì¡´ ìŒì„± ì •ì§€
            speechSynthesis.cancel();

            // ìŒì„± ì¬ìƒ
            const utterance = new SpeechSynthesisUtterance(currentActivity.original_story);
            utterance.lang = 'en-US';
            utterance.rate = 0.8;
            utterance.pitch = 1.0;

            utterance.onstart = function() {
                playBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                statusDiv.textContent = 'ìŠ¤í† ë¦¬ë¥¼ ì¬ìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            };

            utterance.onend = function() {
                playBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
                statusDiv.textContent = 'ì¬ìƒ ì™„ë£Œ';
            };

            utterance.onerror = function() {
                playBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
                statusDiv.textContent = 'ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            };

            speechSynthesis.speak(utterance);
        }

        function stopOriginalStory() {
            speechSynthesis.cancel();
            
            const playBtn = document.getElementById('playStoryBtn');
            const stopBtn = document.getElementById('stopStoryBtn');
            const statusDiv = document.getElementById('storyStatus');

            playBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            statusDiv.textContent = 'ì •ì§€ë¨';
        }

        async function generateHattieFeedback() {
            if (allEvaluations.length === 0) {
                alert('í‰ê°€ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = `
                <div class="hattie-feedback">
                    <div class="loading-spinner"></div>
                    <p>Hattieì˜ Visible Learning ì—°êµ¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¢…í•© í”¼ë“œë°±ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            `;
            
            const interactiveScript = document.querySelector('.interactive-script');
            interactiveScript.appendChild(loadingDiv);

            try {
                // ëª¨ë“  ì§ˆë¬¸ê³¼ ë‹µë³€ì„ í•˜ë‚˜ì˜ í…ìŠ¤íŠ¸ë¡œ ê²°í•©
                const combinedQuestion = allEvaluations.map(eval => eval.question).join(' ');
                const combinedAnswer = allEvaluations.map(eval => eval.answer).join(' ');

                const response = await fetch('/api/comprehensive_feedback', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        question: combinedQuestion,
                        answer: combinedAnswer,
                        individual_scores: allEvaluations
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayHattieFeedback(result.hattie_feedback, result.average_score);
                } else {
                    alert('ì¢…í•© í”¼ë“œë°± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error);
                }
            } catch (error) {
                console.error('ì¢…í•© í”¼ë“œë°± ì˜¤ë¥˜:', error);
                alert('ì¢…í•© í”¼ë“œë°± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                loadingDiv.remove();
            }
        }

        function displayHattieFeedback(hattieData, averageScore) {
            const interactiveScript = document.querySelector('.interactive-script');
            
            const hattieHTML = `
                <div class="hattie-feedback">
                    <h3>ğŸ“ Hattieì˜ Visible Learning ê¸°ë°˜ ì¢…í•© í”¼ë“œë°±</h3>
                    <div class="effect-size">í”¼ë“œë°± íš¨ê³¼ í¬ê¸°: 0.70 (ë†’ì€ íš¨ê³¼)</div>
                    
                    <div class="hattie-section">
                        <div class="hattie-question">ğŸ“ˆ ì „ì²´ í•™ìŠµ í‰ê°€</div>
                        <div class="hattie-answer">${hattieData.overall_assessment}</div>
                        <div class="score">í‰ê·  ì ìˆ˜: ${averageScore.toFixed(1)}/10</div>
                    </div>

                    <div class="hattie-section">
                        <div class="hattie-question">ğŸ¯ Hattieì˜ 3ê°€ì§€ í•µì‹¬ ì§ˆë¬¸</div>
                        <div style="margin: 10px 0;">
                            <strong>1. Where am I going? (ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€?)</strong><br>
                            ${hattieData.hattie_analysis.where_am_i_going}
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>2. How am I going? (ì–´ë–»ê²Œ í•˜ê³  ìˆëŠ”ê°€?)</strong><br>
                            ${hattieData.hattie_analysis.how_am_i_going}
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>3. Where to next? (ë‹¤ìŒì— ë¬´ì—‡ì„ í•´ì•¼ í•˜ëŠ”ê°€?)</strong><br>
                            ${hattieData.hattie_analysis.where_to_next}
                        </div>
                    </div>

                    <div class="hattie-section">
                        <div class="hattie-question">âœ… ê°•ì </div>
                        <ul class="strengths-list">
                            ${hattieData.strengths.map(strength => `<li>${strength}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="hattie-section">
                        <div class="hattie-question">ğŸ¯ ê°œì„  ì˜ì—­</div>
                        <ul class="improvements-list">
                            ${hattieData.areas_for_improvement.map(area => `<li>${area}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="hattie-section">
                        <div class="hattie-question">ğŸ“ êµ¬ì²´ì  í–‰ë™ ê³„íš</div>
                        <ul class="actions-list">
                            ${hattieData.specific_actions.map(action => `<li>${action}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="hattie-section">
                        <div class="hattie-question">ğŸ§  ìê¸°ì¡°ì ˆ í•™ìŠµ íŒ</div>
                        <ul class="actions-list">
                            ${hattieData.self_regulation_tips.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="hattie-section">
                        <div class="hattie-question">ğŸ¯ ë‹¤ìŒ ëª©í‘œ</div>
                        <ul class="actions-list">
                            ${hattieData.next_goals.map(goal => `<li>${goal}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="hattie-section">
                        <div class="hattie-question">ğŸ’ª ê²©ë ¤ ë©”ì‹œì§€</div>
                        <div class="hattie-answer">${hattieData.encouragement}</div>
                    </div>

                    <div class="hattie-principles">
                        <strong>ğŸ“š Hattieì˜ í”¼ë“œë°± ì›ì¹™:</strong><br>
                        â€¢ ê³¼ì œ ìˆ˜ì¤€: ë¬´ì—‡ì´ ì˜ëª»ë˜ì—ˆëŠ”ì§€<br>
                        â€¢ ê³¼ì • ìˆ˜ì¤€: ì–´ë–»ê²Œ ê°œì„ í•  ìˆ˜ ìˆëŠ”ì§€<br>
                        â€¢ ìê¸°ì¡°ì ˆ ìˆ˜ì¤€: í•™ìŠµìê°€ ìŠ¤ìŠ¤ë¡œ ëª¨ë‹ˆí„°ë§í•˜ëŠ” ë°©ë²•
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="resetInteractiveMode()">ìƒˆë¡œìš´ ìˆ˜ì—… ì‹œì‘</button>
                    </div>
                </div>
            `;
            
            interactiveScript.innerHTML = hattieHTML;
        }
    </script>
</body>
</html>

